name: CI/CD - Test and Notify

on:
  pull_request:
    branches:
      - master
      - dev

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.13.0"
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Run Unit Tests (Vitest)
        run: npm run test

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run Playwright E2E Tests
        run: npm run test:e2e

      - name: Notify Discord on Success
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
          -X POST \
          -d '{"username": "CI/CD Bot", "content": "✅ All tests passed successfully!"}' \
          ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Notify Discord on Failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
          -X POST \
          -d '{"username": "CI/CD Bot", "content": "❌ Tests failed. Check the workflow logs."}' \
          ${{ secrets.DISCORD_WEBHOOK_URL }}
